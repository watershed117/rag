<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG 数据管理系统</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .danger {
            background-color: #e74c3c;
        }
        .danger:hover {
            background-color: #c0392b;
        }
        .success {
            background-color: #2ecc71;
        }
        .success:hover {
            background-color: #27ae60;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .json-viewer {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            white-space: fast-food;
        }
        .hidden {
            display: none;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: #333;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #3498db;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background-color: white;
        }
        .tabcontent.active {
            display: block;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .metadata-container {
            margin-bottom: 10px;
        }
        .metadata-row {
            display: flex;
            margin-bottom: 8px;
        }
        .metadata-row input {
            flex: 1;
            margin-right: 10px;
        }
        .metadata-row button {
            width: auto;
        }
        .metadata-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
            font-family: monospace;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
        }
        .pagination-info {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .page-size-selector {
            margin-left: 10px;
        }
        .release-disk-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .action-buttons {
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>RAG 数据管理系统</h1>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'collections')">集合管理</button>
            <button class="tablinks" onclick="openTab(event, 'data')">数据管理</button>
            <button class="tablinks" onclick="openTab(event, 'query')">查询测试</button>
        </div>
        
        <div id="collections" class="tabcontent active">
            <div class="section">
                <h2>集合管理</h2>
                
                <div class="form-group">
                    <label for="collectionName">集合名称</label>
                    <input type="text" id="collectionName" placeholder="输入集合名称 (4-64个字符)">
                </div>
                
                <div class="form-group metadata-container">
                    <label>元数据</label>
                    <div id="collectionMetadataRows">
                        <div class="metadata-row">
                            <input type="text" placeholder="键" class="metadata-key">
                            <input type="text" placeholder="值" class="metadata-value">
                            <button onclick="addMetadataRow(this, 'collection')">+</button>
                            <button onclick="removeMetadataRow(this)" class="danger">-</button>
                        </div>
                    </div>
                    <button onclick="addMetadataRow(null, 'collection')">添加更多元数据</button>
                    <div class="metadata-preview">
                        <strong>元数据预览:</strong>
                        <div id="collectionMetadataPreview">{}</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="createCollection()" class="success">创建集合</button>
                    <button onclick="deleteCollection()" class="danger">删除集合</button>
                    <button onclick="changeCollection()">切换集合</button>
                    <button onclick="listCollections()">刷新集合列表</button>
                </div>
                
                <div id="collectionStatus" class="status hidden"></div>
                
                <div class="release-disk-section">
                    <h3>磁盘管理</h3>
                    <div class="form-group">
                        <label for="releasePath">释放集合磁盘空间</label>
                        <input type="text" id="releasePath" placeholder="输入要释放的集合路径" style="margin-bottom: 10px;">
                        <div>
                            <button onclick="releaseDisk()" class="danger">释放磁盘空间</button>
                        </div>
                    </div>
                </div>
                
                <h3>当前集合列表</h3>
                <table id="collectionsTable">
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="data" class="tabcontent">
            <div class="section">
                <h2>数据管理</h2>
                <p id="currentCollection">当前集合: <span id="currentCollectionName">未选择</span></p>
                
                <div class="form-group">
                    <label for="dataText">文本内容</label>
                    <textarea id="dataText" rows="3" placeholder="输入要存储的文本"></textarea>
                </div>
                
                <div class="form-group metadata-container">
                    <label>元数据</label>
                    <div id="dataMetadataRows">
                        <div class="metadata-row">
                            <input type="text" placeholder="键" class="metadata-key">
                            <input type="text" placeholder="值" class="metadata-value">
                            <button onclick="addMetadataRow(this, 'data')">+</button>
                            <button onclick="removeMetadataRow(this)" class="danger">-</button>
                        </div>
                    </div>
                    <button onclick="addMetadataRow(null, 'data')">添加更多元数据</button>
                    <div class="metadata-preview">
                        <strong>元数据预览:</strong>
                        <div id="dataMetadataPreview">{}</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="storeData()" class="success">存储数据</button>
                    <button onclick="getAllData()">获取所有数据</button>
                </div>
                
                <div id="dataStatus" class="status hidden"></div>
                
                <h3>当前集合中的数据</h3>
                <div class="pagination-controls">
                    <div class="form-group" style="display: inline-block; margin-right: 20px;">
                        <label for="dataPageSize">每页显示:</label>
                        <select id="dataPageSize" class="page-size-selector" onchange="changeDataPageSize()">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="pagination-info" id="dataPaginationInfo">第 1 页，共 1 页</div>
                </div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>文本内容</th>
                            <th>元数据</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="pagination" id="dataPagination">
                    <button onclick="prevDataPage()" id="prevDataPage" disabled>上一页</button>
                    <button onclick="nextDataPage()" id="nextDataPage" disabled>下一页</button>
                </div>
            </div>
        </div>
        
        <div id="query" class="tabcontent">
            <div class="section">
                <h2>查询测试</h2>
                <p id="queryCurrentCollection">当前集合: <span id="queryCollectionName">未选择</span></p>
                
                <div class="form-group">
                    <label for="queryText">查询文本</label>
                    <input type="text" id="queryText" placeholder="输入查询文本">
                </div>
                
                <div class="form-group">
                    <label for="topK">返回结果数量</label>
                    <input type="number" id="topK" value="3" min="1">
                </div>
                
                <div class="form-group">
                    <label for="similarityThreshold">相似度阈值 (0-1)</label>
                    <input type="number" id="similarityThreshold" value="0.5" min="0" max="1" step="0.1">
                </div>
                
                <div class="action-buttons">
                    <button onclick="queryData()">执行查询</button>
                </div>
                
                <div id="queryStatus" class="status hidden"></div>
                
                <h3>查询结果</h3>
                <div class="pagination-controls">
                    <div class="form-group" style="display: inline-block; margin-right: 20px;">
                        <label for="queryPageSize">每页显示:</label>
                        <select id="queryPageSize" class="page-size-selector" onchange="changeQueryPageSize()">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="pagination-info" id="queryPaginationInfo">第 1 页，共 1 页</div>
                </div>
                <table id="queryResultsTable">
                    <thead>
                        <tr>
                            <th>相似度</th>
                            <th>文本内容</th>
                            <th>元数据</th>
                            <th>ID</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="pagination" id="queryPagination">
                    <button onclick="prevQueryPage()" id="prevQueryPage" disabled>上一页</button>
                    <button onclick="nextQueryPage()" id="nextQueryPage" disabled>下一页</button>
                </div>
            </div>
        </div>
        

    <script>
        let currentCollection = null;
        
        // 数据管理分页相关变量
        let dataCurrentPage = 1;
        let dataPageSize = 10;
        let dataTotalItems = 0;
        let dataTotalPages = 1;
        let allDataItems = [];
        
        // 查询结果分页相关变量
        let queryCurrentPage = 1;
        let queryPageSize = 10;
        let queryTotalItems = 0;
        let queryTotalPages = 1;
        let queryResults = [];
        
        // 切换标签页
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontents.length; i++) {
                tabcontents[i].classList.remove("active");
            }
            
            const tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        // 显示状态消息
        function showStatus(elementId, message, isSuccess) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.classList.remove("hidden", "success", "error");
            statusElement.classList.add(isSuccess ? "success" : "error");
            
            setTimeout(() => {
                statusElement.classList.add("hidden");
            }, 5000);
        }
        
        // 添加元数据行
        function addMetadataRow(button, type) {
            const containerId = type === 'collection' ? 'collectionMetadataRows' : 'dataMetadataRows';
            const container = document.getElementById(containerId);
            
            const newRow = document.createElement('div');
            newRow.className = 'metadata-row';
            newRow.innerHTML = `
                <input type="text" placeholder="键" class="metadata-key">
                <input type="text" placeholder="值" class="metadata-value">
                <button onclick="addMetadataRow(this, '${type}')">+</button>
                <button onclick="removeMetadataRow(this)" class="danger">-</button>
            `;
            
            if (button) {
                button.parentNode.parentNode.insertBefore(newRow, button.parentNode.nextSibling);
            } else {
                container.appendChild(newRow);
            }
            
            // 为新的输入框添加事件监听器
            const inputs = newRow.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', () => updateMetadataPreview(type));
            });
            
            updateMetadataPreview(type);
        }
        
        // 移除元数据行
        function removeMetadataRow(button) {
            const row = button.parentNode;
            const container = row.parentNode;
            
            // 确保至少保留一行
            if (container.querySelectorAll('.metadata-row').length > 1) {
                container.removeChild(row);
                updateMetadataPreview(container.id.includes('collection') ? 'collection' : 'data');
            }
        }
        
        // 更新元数据预览
        function updateMetadataPreview(type) {
            const containerId = type === 'collection' ? 'collectionMetadataRows' : 'dataMetadataRows';
            const previewId = type === 'collection' ? 'collectionMetadataPreview' : 'dataMetadataPreview';
            
            const rows = document.getElementById(containerId).querySelectorAll('.metadata-row');
            const metadata = {};
            
            rows.forEach(row => {
                const keyInput = row.querySelector('.metadata-key');
                const valueInput = row.querySelector('.metadata-value');
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();
                
                if (key) {
                    metadata[key] = value;
                }
            });
            
            document.getElementById(previewId).textContent = JSON.stringify(metadata, null, 2);
        }
        
        // 获取元数据对象
        function getMetadata(type) {
            const containerId = type === 'collection' ? 'collectionMetadataRows' : 'dataMetadataRows';
            const rows = document.getElementById(containerId).querySelectorAll('.metadata-row');
            const metadata = {};
            
            rows.forEach(row => {
                const keyInput = row.querySelector('.metadata-key');
                const valueInput = row.querySelector('.metadata-value');
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();
                
                if (key) {
                    metadata[key] = value;
                }
            });
            
            return metadata;
        }
        
        // 设置元数据输入
        function setMetadata(type, metadataObj) {
            const containerId = type === 'collection' ? 'collectionMetadataRows' : 'dataMetadataRows';
            const container = document.getElementById(containerId);
            
            // 清空现有行
            container.innerHTML = '';
            
            // 如果没有元数据，添加一个空行
            if (!metadataObj || Object.keys(metadataObj).length === 0) {
                addMetadataRow(null, type);
                return;
            }
            
            // 为每个键值对添加一行
            Object.entries(metadataObj).forEach(([key, value]) => {
                const newRow = document.createElement('div');
                newRow.className = 'metadata-row';
                newRow.innerHTML = `
                    <input type="text" placeholder="键" class="metadata-key" value="${key}">
                    <input type="text" placeholder="值" class="metadata-value" value="${value}">
                    <button onclick="addMetadataRow(this, '${type}')">+</button>
                    <button onclick="removeMetadataRow(this)" class="danger">-</button>
                `;
                container.appendChild(newRow);
                
                // 为新的输入框添加事件监听器
                const inputs = newRow.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', () => updateMetadataPreview(type));
                });
            });
            
            // 更新预览
            updateMetadataPreview(type);
        }
        
        // 创建集合
        async function createCollection() {
            const name = document.getElementById("collectionName").value.trim();
            const metadata = getMetadata('collection');
            
            if (name.length < 4 || name.length > 64) {
                showStatus("collectionStatus", "集合名称长度应在4-64个字符之间", false);
                return;
            }
            
            try {
                const response = await fetch(`/rag/create_collection/${name}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ metadata })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "创建集合失败");
                }
                
                showStatus("collectionStatus", `集合 ${name} 创建成功`, true);
                listCollections();
                document.getElementById("collectionName").value = "";
                setMetadata('collection', {});
            } catch (error) {
                showStatus("collectionStatus", error.message, false);
            }
        }
        
        // 删除集合
        async function deleteCollection() {
            const name = document.getElementById("collectionName").value.trim();
            
            if (!name) {
                showStatus("collectionStatus", "请输入要删除的集合名称", false);
                return;
            }
            
            if (!confirm(`确定要删除集合 ${name} 吗？此操作不可撤销！`)) {
                return;
            }
            
            try {
                const response = await fetch(`/rag/delete_collection/${name}`, {
                    method: "GET"
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "删除集合失败");
                }
                
                showStatus("collectionStatus", `集合 ${name} 删除成功`, true);
                listCollections();
                document.getElementById("collectionName").value = "";
                
                if (currentCollection === name) {
                    currentCollection = null;
                    updateCurrentCollectionDisplay();
                }
            } catch (error) {
                showStatus("collectionStatus", error.message, false);
            }
        }
        
        // 切换集合
        async function changeCollection() {
            const name = document.getElementById("collectionName").value.trim();
            
            if (!name) {
                showStatus("collectionStatus", "请输入要切换的集合名称", false);
                return;
            }
            
            try {
                const response = await fetch(`/rag/change_collection/${name}`, {
                    method: "GET"
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "切换集合失败");
                }
                
                currentCollection = name;
                updateCurrentCollectionDisplay();
                showStatus("collectionStatus", `已切换到集合 ${name}`, true);
                getAllData();
            } catch (error) {
                showStatus("collectionStatus", error.message, false);
            }
        }
        
        // 列出所有集合
        async function listCollections() {
            try {
                const response = await fetch("/rag/list_collections");
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "获取集合列表失败");
                }
                
                const data = await response.json();
                const tableBody = document.querySelector("#collectionsTable tbody");
                tableBody.innerHTML = "";
                
                if (data.collections && data.collections.length > 0) {
                    data.collections.forEach(collection => {
                        const row = document.createElement("tr");
                        
                        const nameCell = document.createElement("td");
                        nameCell.textContent = collection;
                        row.appendChild(nameCell);
                        
                        const actionCell = document.createElement("td");
                        const selectButton = document.createElement("button");
                        selectButton.textContent = "选择";
                        selectButton.onclick = () => {
                            document.getElementById("collectionName").value = collection;
                            changeCollection();
                        };
                        actionCell.appendChild(selectButton);
                        
                        row.appendChild(actionCell);
                        tableBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement("tr");
                    const cell = document.createElement("td");
                    cell.colSpan = 2;
                    cell.textContent = "没有可用的集合";
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            } catch (error) {
                showStatus("collectionStatus", error.message, false);
            }
        }
        
        // 更新当前集合显示
        function updateCurrentCollectionDisplay() {
            document.getElementById("currentCollectionName").textContent = currentCollection || "未选择";
            document.getElementById("queryCollectionName").textContent = currentCollection || "未选择";
        }
        
        // 存储数据
        async function storeData() {
            if (!currentCollection) {
                showStatus("dataStatus", "请先选择集合", false);
                return;
            }
            
            const text = document.getElementById("dataText").value.trim();
            const metadata = getMetadata('data');
            
            if (!text) {
                showStatus("dataStatus", "请输入要存储的文本", false);
                return;
            }
            
            try {
                const response = await fetch("/rag/store", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        text,
                        metadata: Object.keys(metadata).length > 0 ? metadata : undefined
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "存储数据失败");
                }
                
                showStatus("dataStatus", "数据存储成功", true);
                document.getElementById("dataText").value = "";
                setMetadata('data', {});
                getAllData();
            } catch (error) {
                showStatus("dataStatus", error.message, false);
            }
        }
        
        // 获取所有数据
        async function getAllData() {
            if (!currentCollection) {
                showStatus("dataStatus", "请先选择集合", false);
                return;
            }
            
            try {
                const response = await fetch("/rag/get_data");
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "获取数据失败");
                }
                
                const data = await response.json();
                allDataItems = data.data || [];
                dataTotalItems = allDataItems.length;
                dataTotalPages = Math.ceil(dataTotalItems / dataPageSize);
                
                updateDataPagination();
                renderDataTable();
            } catch (error) {
                showStatus("dataStatus", error.message, false);
            }
        }
        
        // 渲染数据表格
        function renderDataTable() {
            const tableBody = document.querySelector("#dataTable tbody");
            tableBody.innerHTML = "";
            
            if (allDataItems.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 4;
                cell.textContent = "当前集合中没有数据";
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }
            
            const startIndex = (dataCurrentPage - 1) * dataPageSize;
            const endIndex = Math.min(startIndex + dataPageSize, dataTotalItems);
            
            for (let i = startIndex; i < endIndex; i++) {
                const item = allDataItems[i];
                const row = document.createElement("tr");
                
                const idCell = document.createElement("td");
                idCell.textContent = item.id;
                row.appendChild(idCell);
                
                const textCell = document.createElement("td");
                textCell.textContent = item.document;
                row.appendChild(textCell);
                
                const metadataCell = document.createElement("td");
                metadataCell.textContent = JSON.stringify(item.metadata || {}, null, 2);
                row.appendChild(metadataCell);
                
                const actionCell = document.createElement("td");
                
                const deleteButton = document.createElement("button");
                deleteButton.textContent = "删除";
                deleteButton.classList.add("danger");
                deleteButton.onclick = () => deleteItem(item.id);
                actionCell.appendChild(deleteButton);
                
                const updateButton = document.createElement("button");
                updateButton.textContent = "更新";
                updateButton.onclick = () => prepareUpdate(item);
                actionCell.appendChild(updateButton);
                
                row.appendChild(actionCell);
                tableBody.appendChild(row);
            }
        }
        
        // 更新数据分页控件
        function updateDataPagination() {
            document.getElementById("dataPaginationInfo").textContent = 
                `第 ${dataCurrentPage} 页，共 ${dataTotalPages} 页 (共 ${dataTotalItems} 条数据)`;
            
            document.getElementById("prevDataPage").disabled = dataCurrentPage <= 1;
            document.getElementById("nextDataPage").disabled = dataCurrentPage >= dataTotalPages;
        }
        
        // 改变数据页大小
        function changeDataPageSize() {
            dataPageSize = parseInt(document.getElementById("dataPageSize").value);
            dataCurrentPage = 1;
            dataTotalPages = Math.ceil(dataTotalItems / dataPageSize);
            updateDataPagination();
            renderDataTable();
        }
        
        // 上一页数据
        function prevDataPage() {
            if (dataCurrentPage > 1) {
                dataCurrentPage--;
                updateDataPagination();
                renderDataTable();
            }
        }
        
        // 下一页数据
        function nextDataPage() {
            if (dataCurrentPage < dataTotalPages) {
                dataCurrentPage++;
                updateDataPagination();
                renderDataTable();
            }
        }
        
        // 删除数据项
        async function deleteItem(id) {
            if (!confirm(`确定要删除ID为 ${id} 的数据吗？此操作不可撤销！`)) {
                return;
            }
            
            try {
                const response = await fetch("/rag/delete", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ id })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "删除数据失败");
                }
                
                showStatus("dataStatus", `ID ${id} 删除成功`, true);
                getAllData();
            } catch (error) {
                showStatus("dataStatus", error.message, false);
            }
        }

        
        // 准备更新数据项
        function prepareUpdate(item) {
            document.getElementById("dataText").value = item.document || "";
            setMetadata('data', item.metadata || {});
            
            // 添加一个隐藏的ID字段用于更新
            const updateIdInput = document.createElement("input");
            updateIdInput.type = "hidden";
            updateIdInput.id = "updateId";
            updateIdInput.value = item.id;
            
            const formGroup = document.querySelector("#data .form-group:first-child");
            if (!document.getElementById("updateId")) {
                formGroup.appendChild(updateIdInput);
            } else {
                document.getElementById("updateId").value = item.id;
            }
            
            // 修改存储按钮为更新按钮
            const storeBtn = document.querySelector("button[onclick='storeData()']");
            storeBtn.textContent = "更新数据";
            storeBtn.onclick = updateData;
            
            storeBtn.classList.remove("success");
            storeBtn.classList.add("warning");
            storeBtn.style.backgroundColor = "#f39c12";
            
            showStatus("dataStatus", `准备更新ID ${item.id}`, true);
        }
        
        // 更新数据
        async function updateData() {
            const updateId = document.getElementById("updateId")?.value;
            
            if (!updateId) {
                showStatus("dataStatus", "更新失败：缺少ID", false);
                return;
            }
            
            const text = document.getElementById("dataText").value.trim();
            const metadata = getMetadata('data');
            
            if (!text) {
                showStatus("dataStatus", "请输入要更新的文本", false);
                return;
            }
            
            try {
                const response = await fetch("/rag/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        id: updateId,
                        text,
                        metadata: Object.keys(metadata).length > 0 ? metadata : undefined
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "更新数据失败");
                }
                
                showStatus("dataStatus", `ID ${updateId} 更新成功`, true);
                document.getElementById("dataText").value = "";
                setMetadata('data', {});
                
                // 恢复存储按钮
                const storeBtn = document.querySelector("button[onclick='updateData']");
                storeBtn.textContent = "存储数据";
                storeBtn.onclick = storeData;
                storeBtn.classList.remove("warning");
                storeBtn.classList.add("success");
                storeBtn.style.backgroundColor = "";
                
                // 移除隐藏的ID字段
                const updateIdInput = document.getElementById("updateId");
                if (updateIdInput) {
                    updateIdInput.remove();
                }
                
                getAllData();
            } catch (error) {
                showStatus("dataStatus", error.message, false);
            }
        }
        
    // 查询数据
    async function queryData() {
        if (!currentCollection) {
            showStatus("queryStatus", "请先选择集合", false);
            return;
        }
        
        const queryText = document.getElementById("queryText").value.trim();
        const topK = parseInt(document.getElementById("topK").value);
        const similarityThreshold = parseFloat(document.getElementById("similarityThreshold").value);
        
        if (!queryText) {
            showStatus("queryStatus", "请输入查询文本", false);
            return;
        }
        
        try {
            const response = await fetch("/rag/query", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    query_text: queryText,
                    top_k: topK,
                    similarity: similarityThreshold
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || "查询失败");
            }
            
            const data = await response.json();
            console.log("原始数据:", data);
            
            queryResults = Array.isArray(data) ? data : []; // 确保是数组
            queryTotalItems = queryResults.length;
            queryTotalPages = Math.ceil(queryTotalItems / queryPageSize);
            
            updateQueryPagination();
            renderQueryResults();
        } catch (error) {
            showStatus("queryStatus", error.message, false);
        }
    }

    function renderQueryResults() {
        const tableBody = document.querySelector("#queryResultsTable tbody");
        if (!tableBody) {
            console.error("表格 body 元素未找到");
            return;
        }
        tableBody.innerHTML = "";
        
        if (queryResults.length === 0) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4">没有匹配的查询结果</td>`;
            tableBody.appendChild(row);
            return;
        }
        
        const startIndex = (queryCurrentPage - 1) * queryPageSize;
        const endIndex = Math.min(startIndex + queryPageSize, queryTotalItems);
        
        for (let i = startIndex; i < endIndex; i++) {
            const result = queryResults[i] || {};
            const row = document.createElement("tr");
            
            // 相似度
            const scoreCell = document.createElement("td");
            scoreCell.textContent = result.similarity || "N/A";
            row.appendChild(scoreCell);
            
            // 文本内容
            const textCell = document.createElement("td");
            textCell.textContent = result.document || "无内容";
            row.appendChild(textCell);
            
            // 元数据
            const metadataCell = document.createElement("td");
            metadataCell.textContent = result.metadata ? 
                JSON.stringify(result.metadata, null, 2) : "无元数据";
            row.appendChild(metadataCell);
            
            // ID
            const idCell = document.createElement("td");
            idCell.textContent = result.id || "未知ID";
            row.appendChild(idCell);
            
            tableBody.appendChild(row);
        }
    }

        
        // 更新查询分页控件
        function updateQueryPagination() {
            document.getElementById("queryPaginationInfo").textContent = 
                `第 ${queryCurrentPage} 页，共 ${queryTotalPages} 页 (共 ${queryTotalItems} 条结果)`;
            
            document.getElementById("prevQueryPage").disabled = queryCurrentPage <= 1;
            document.getElementById("nextQueryPage").disabled = queryCurrentPage >= queryTotalPages;
        }
        
        // 改变查询页大小
        function changeQueryPageSize() {
            queryPageSize = parseInt(document.getElementById("queryPageSize").value);
            queryCurrentPage = 1;
            queryTotalPages = Math.ceil(queryTotalItems / queryPageSize);
            updateQueryPagination();
            renderQueryResults();
        }
        
        // 上一页查询结果
        function prevQueryPage() {
            if (queryCurrentPage > 1) {
                queryCurrentPage--;
                updateQueryPagination();
                renderQueryResults();
            }
        }
        
        // 下一页查询结果
        function nextQueryPage() {
            if (queryCurrentPage < queryTotalPages) {
                queryCurrentPage++;
                updateQueryPagination();
                renderQueryResults();
            }
        }

        // 释放磁盘空间
        async function releaseDisk() {
            const path = document.getElementById("releasePath").value.trim();
            
            if (!path) {
                showStatus("collectionStatus", "请输入要释放的集合路径", false);
                return;
            }
            
            if (!confirm(`确定要释放集合 ${path} 的磁盘空间吗？`)) {
                return;
            }
            
            try {
                const response = await fetch("/rag/release_disk", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        path: path
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || "释放磁盘空间失败");
                }
                
                const result = await response.json();
                showStatus("collectionStatus", result.message, true);
                document.getElementById("releasePath").value = "";
            } catch (error) {
                showStatus("collectionStatus", error.message, false);
            }
        }

        
        // 初始化页面
        document.addEventListener("DOMContentLoaded", function() {
            listCollections();
            updateCurrentCollectionDisplay();
            
            // 为现有的元数据输入框添加事件监听器
            document.querySelectorAll('.metadata-key, .metadata-value').forEach(input => {
                input.addEventListener('input', () => {
                    const container = input.closest('.metadata-container');
                    if (container) {
                        const type = container.id.includes('collection') ? 'collection' : 'data';
                        updateMetadataPreview(type);
                    }
                });
            });
        });
    </script>
</body>
</html>
